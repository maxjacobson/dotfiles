#!/usr/bin/env fish

# More info: https://www.hardscrabble.net/2015/improved-commit-squashing

# the git_fib function does the work of git fibbing
function git_fib
    if ! test -d .git
        echo "Not a git repo! Get out of here!"
        exit 1
    end

    if test -e .git/CHERRY_PICK_HEAD
        echo "I don't want to fib right now, you're in the middle of a cherry-pick"
        exit 1
    end

    if test -e .git/rebase-apply
        echo "I don't want to fib right now, you're mid rebase"
        exit 1
    end

    set --local git_status (git status --porcelain)
    if test -n "$git_status"
        echo "I don't want to fib right now, you have uncommitted work"
        exit 1
    end

    set --local timestamp (date -R)

    # Amend the last commit's timestamp to right now
    git commit --no-edit --amend --date="$timestamp"
end

# call the function and do the thing!
git_fib
